#!/usr/bin/env bash

set -o errexit
set -o pipefail

CURRENT_DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
DUMP_FILE="$1"
TABLE_NAME="$2"
CHARACTER_SET="${3:-utf8}"
(
  if [[ "${DUMP_FILE}" == *tar.gz ]]; then
    tar xOfz "${DUMP_FILE}" 
  elif [[ "${DUMP_FILE}" == *.gz ]]; then
    zcat "${DUMP_FILE}"
  fi
  # zcat will continue to write to stdout whereas awk has finished if table has been found
  # we detect this case because zcat will return code 141 because pipe closed
  status=$?
  if [[ $status -eq 141 ]]; then true; else exit $status; fi
) | awk \
  -v CHARACTER_SET="${CHARACTER_SET}" \
  -v TABLE_NAME="${TABLE_NAME}" \
  -f "${CURRENT_DIR}/dbImportTableStream.awk" || exit $?
